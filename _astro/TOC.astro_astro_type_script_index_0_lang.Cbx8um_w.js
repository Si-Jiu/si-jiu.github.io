class h extends HTMLElement{tocEl=null;visibleClass="visible";observer;anchorNavTarget=null;headingIdxMap=new Map;headings=[];sections=[];tocEntries=[];active=[];activeIndicator=null;constructor(){super(),this.observer=new IntersectionObserver(this.markVisibleSection,{threshold:0})}markVisibleSection=t=>{t.forEach(i=>{const e=i.target.children[0]?.getAttribute("id"),n=e?this.headingIdxMap.get(e):void 0;n!=null&&(this.active[n]=i.isIntersecting),i.isIntersecting&&this.anchorNavTarget==i.target.firstChild&&(this.anchorNavTarget=null)}),this.active.includes(!0)||this.fallback(),this.update()};toggleActiveHeading=()=>{let t=this.active.length-1,i=this.active.length-1,e=-1;for(;t>=0&&!this.active[t];)this.tocEntries[t].classList.remove(this.visibleClass),t--;for(;t>=0&&this.active[t];)this.tocEntries[t].classList.add(this.visibleClass),i=Math.min(i,t),e=Math.max(e,t),t--;for(;t>=0;)this.tocEntries[t].classList.remove(this.visibleClass),t--;if(i>e)this.activeIndicator?.setAttribute("style","opacity: 0");else{let n=this.tocEl?.getBoundingClientRect().top||0,o=this.tocEl?.scrollTop||0,r=this.tocEntries[i].getBoundingClientRect().top-n+o,c=this.tocEntries[e].getBoundingClientRect().bottom-n+o;this.activeIndicator?.setAttribute("style",`top: ${r}px; height: ${c-r}px`)}};scrollToActiveHeading=()=>{if(this.anchorNavTarget||!this.tocEl)return;const t=document.querySelectorAll(`#toc .${this.visibleClass}`);if(!t.length)return;const i=t[0],e=t[t.length-1],n=this.tocEl.clientHeight;let o;e.getBoundingClientRect().bottom-i.getBoundingClientRect().top<.9*n?o=i.offsetTop-32:o=e.offsetTop-n*.8,this.tocEl.scrollTo({top:o,left:0,behavior:"smooth"})};update=()=>{requestAnimationFrame(()=>{this.toggleActiveHeading(),this.scrollToActiveHeading()})};fallback=()=>{if(this.sections.length)for(let t=0;t<this.sections.length;t++){let i=this.sections[t].getBoundingClientRect().top,e=this.sections[t].getBoundingClientRect().bottom;if(this.isInRange(i,0,window.innerHeight)||this.isInRange(e,0,window.innerHeight)||i<0&&e>window.innerHeight)this.markActiveHeading(t);else if(i>window.innerHeight)break}};markActiveHeading=t=>{this.active[t]=!0};handleAnchorClick=t=>{const i=t.composedPath().find(e=>e instanceof HTMLAnchorElement);if(i){t.preventDefault();const e=decodeURIComponent(i.hash?.substring(1)),n=document.getElementById(e);if(n){const c=n.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:c,behavior:"smooth"})}const o=this.headingIdxMap.get(e);o!==void 0?this.anchorNavTarget=this.headings[o]:this.anchorNavTarget=null}};isInRange(t,i,e){return i<t&&t<e}connectedCallback(){const t=document.querySelector(".custom-md")||document.querySelector(".prose")||document.querySelector(".markdown-content");let i=!1;const e=()=>{i||(i=!0,this.init())};t?(t.addEventListener("animationend",e,{once:!0}),setTimeout(e,300)):(e(),setTimeout(e,300))}init(){if(this.regenerateTOC(),this.tocEl=this,this.tocEl.addEventListener("click",this.handleAnchorClick,{capture:!0}),this.activeIndicator=document.getElementById("active-indicator"),this.tocEntries=Array.from(this.querySelectorAll("a[href^='#']")),this.tocEntries.length!==0){this.sections=new Array(this.tocEntries.length),this.headings=new Array(this.tocEntries.length);for(let t=0;t<this.tocEntries.length;t++){const i=decodeURIComponent(this.tocEntries[t].hash?.substring(1)),e=document.getElementById(i),n=e?.parentElement;e instanceof HTMLElement&&n instanceof HTMLElement&&(this.headings[t]=e,this.sections[t]=n,this.headingIdxMap.set(i,t))}this.active=new Array(this.tocEntries.length).fill(!1),this.sections.forEach(t=>this.observer.observe(t)),this.fallback(),this.update()}}regenerateTOC(t=0){if(!(window.location.pathname.includes("/posts/")||document.querySelector(".custom-md, .markdown-content")!==null)){this.innerHTML="";return}const e=Array.from(document.querySelectorAll("h1, h2, h3, h4, h5, h6")).filter(s=>s.id).map(s=>({depth:parseInt(s.tagName.substring(1)),slug:s.id,text:(s.textContent||"").replace(/#+\s*$/,"")}));if(e.length===0&&t<3){setTimeout(()=>this.regenerateTOC(t+1),120);return}if(e.length===0){this.innerHTML="";return}const n=Math.min(...e.map(s=>s.depth)),o=3;let r=1;const c=e.filter(s=>s.depth<n+o).map(s=>{const a=s.depth===n?"":s.depth===n+1?"ml-4":"ml-8",l=s.depth===n?r++:s.depth===n+1?'<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>':'<div class="transition w-1.5 h-1.5 rounded-sm bg-black/5 dark:bg-white/10"></div>';return`<a href="#${s.slug}" class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2">
                    <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${a} ${s.depth===n?"bg-[var(--toc-badge-bg)] text-[var(--btn-content)]":""}">
                        ${l}
                    </div>
                    <div class="transition text-sm ${s.depth<=n+1?"text-50":"text-30"}">${s.text}</div>
                </a>`}).join("");this.innerHTML=c+'<div id="active-indicator" style="opacity: 0" class="-z-10 absolute bg-[var(--toc-btn-hover)] left-0 right-0 rounded-xl transition-all group-hover:bg-transparent border-2 border-[var(--toc-btn-hover)] group-hover:border-[var(--toc-btn-active)] border-dashed"></div>'}disconnectedCallback(){this.sections.forEach(t=>this.observer.unobserve(t)),this.observer.disconnect(),this.tocEl?.removeEventListener("click",this.handleAnchorClick)}}customElements.get("table-of-contents")||customElements.define("table-of-contents",h);
